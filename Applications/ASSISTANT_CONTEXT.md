# Контекст проекта для AI-ассистента

## Общая информация о проекте
- Название проекта: Система анализа заказов и продаж
- Цель проекта: Разработка современного приложения для анализа заказов и продаж с разделением на Backend и Frontend
- Текущий статус: Backend (WEB API) готов и находится в стадии первичного тестирования, Frontend часть в процессе разработки
- Основные технологии: 
  - Backend: ASP.NET Core Web API
  - Frontend: ASP.NET Core Razor Pages
  - База данных: SQL Server
- Приложение рассчитано ТОЛЬКО на розничные продажи для физических лиц
- Оптовые продажи и работа с юридическими лицами исключены из функционала

## Архитектурные решения
1. Разделение на Backend и Frontend:
   - Backend (Server): REST API
   - Frontend: Razor Pages с использованием API
   - Взаимодействие через HTTP запросы

2. Frontend архитектура:
   - Использование Razor Pages вместо SPA
   - Серверный рендеринг для лучшей производительности
   - Встроенная поддержка Identity
   - Использование Tag Helpers
   - Встроенная валидация форм

3. Backend архитектура:
   - REST API с использованием контроллеров:
     - AuthController:
       - POST /api/auth/login - вход в систему
       - POST /api/auth/register - регистрация
       - GET /api/auth/me - информация о текущем пользователе
     - OrdersController:
       - GET /api/orders - список всех заказов (только для менеджеров)
       - GET /api/orders/{id} - информация о заказе
       - POST /api/orders - создание заказа
       - PUT /api/orders/{id} - обновление заказа
       - DELETE /api/orders/{id} - удаление заказа
       - GET /api/orders/user/{userId} - заказы пользователя
       - PUT /api/orders/{orderId}/delivery - обновление доставки
     - ProductsController:
       - GET /api/products - список всех товаров
       - GET /api/products/{id} - информация о товаре
       - POST /api/products - создание товара
       - PUT /api/products/{id} - обновление товара
       - DELETE /api/products/{id} - удаление товара
       - GET /api/products/name/{name} - поиск по названию
       - GET /api/products/barcode/{barcode} - поиск по штрих-коду
       - GET /api/products/category/{category} - поиск по категории
       - GET /api/products/price-range - поиск по диапазону цен
     - SalesController:
       - GET /api/sales - список всех продаж
       - GET /api/sales/{id} - информация о продаже
       - POST /api/sales - создание продажи
       - PUT /api/sales/{id} - обновление продажи
       - DELETE /api/sales/{id} - удаление продажи
       - GET /api/sales/order/{orderId} - продажи по заказу
       - GET /api/sales/stock/{stockId} - продажи по складу
       - GET /api/sales/status/{status} - продажи по статусу
       - GET /api/sales/date-range - продажи по диапазону дат
       - POST /api/sales/{id}/complete - завершение продажи
       - POST /api/sales/{id}/cancel - отмена продажи
     - StocksController:
       - GET /api/stocks - список всех складов
       - GET /api/stocks/{id} - информация о складе
       - POST /api/stocks - создание склада
       - PUT /api/stocks/{id} - обновление склада
       - DELETE /api/stocks/{id} - удаление склада
       - GET /api/stocks/name/{name} - поиск по названию
       - GET /api/stocks/address/{address} - поиск по адресу
       - GET /api/stocks/city/{city} - поиск по городу
       - GET /api/stocks/{stockId}/products - товары на складе
       - PUT /api/stocks/{stockId}/products/{productId}/quantity - обновление количества
       - POST /api/stocks/{stockId}/products/{productId} - добавление товара
       - DELETE /api/stocks/{stockId}/products/{productId} - удаление товара
     - ClientsController:
       - GET /api/clients - список всех клиентов
       - GET /api/clients/{id} - информация о клиенте
       - POST /api/clients - создание клиента
       - PUT /api/clients/{id} - обновление клиента
       - DELETE /api/clients/{id} - удаление клиента
       - GET /api/clients/by-phone/{phone} - поиск по телефону
       - GET /api/clients/by-name - поиск по имени и фамилии
     - EmployeesController:
       - GET /api/employees - список всех сотрудников
       - GET /api/employees/{id} - информация о сотруднике
       - POST /api/employees - создание сотрудника
       - PUT /api/employees/{id} - обновление сотрудника
       - DELETE /api/employees/{id} - удаление сотрудника
       - GET /api/employees/role/{role} - поиск по роли
       - GET /api/employees/phone/{phone} - поиск по телефону
       - GET /api/employees/name - поиск по имени и фамилии
   - Swagger для документации API
   - JWT аутентификация
   - Entity Framework Core для работы с БД
   - Ролевая модель с двумя уровнями доступа:
     - Manager (Менеджер) - полный доступ к системе
     - User (Пользователь) - ограниченный доступ к функционалу

## Текущие задачи и приоритеты
1. Разработка Frontend части
   - Статус: В процессе
   - Приоритет: Высокий
   - Зависимости: 
     - Создание базовой структуры Frontend проекта
     - Настройка взаимодействия с API
     - Реализация пользовательского интерфейса
     - Интеграция с существующим API

2. Тестирование Backend API
   - Статус: В процессе
   - Приоритет: Высокий
   - Зависимости:
     - Проверка всех эндпоинтов
     - Валидация бизнес-логики
     - Тестирование производительности
     - Проверка безопасности

3. Интеграция и тестирование
   - Статус: Запланировано
   - Приоритет: Средний
   - Зависимости:
     - Настройка тестового окружения
     - Проверка взаимодействия частей
     - Исправление ошибок

## Принятые решения
- Использование Razor Pages для Frontend вместо SPA
- Разделение на Backend API и Frontend
- Использование JWT для аутентификации
- Swagger для документации API
- Entity Framework Core для работы с БД
- Поэтапная миграция функционала

## Важные замечания и предпочтения
- Сохранение существующей функциональности при миграции
- Обеспечение масштабируемости новой архитектуры
- Безопасность и надежность системы
- Плавный переход на новую архитектуру

## История изменений
- 01.04.2025 - Создание документа с контекстом проекта
- 01.04.2025 - Определение основных задач и приоритетов
- 01.04.2025 - Принятие решения о разделении на Backend и Frontend
- 01.04.2025 - Выбор Razor Pages для Frontend
- 01.04.2025 - Создание базовой структуры проектов
- 01.04.2025 - Фокус на разделении проекта и миграции функционала
- 01.04.2025 - Реализована базовая структура для работы с заказами:
  - Создан ApiService для взаимодействия с Backend API
  - Реализована JWT аутентификация
  - Созданы страницы для работы с заказами (Index, Create, Edit, Details)
  - Настроена валидация форм
  - Реализована обработка ошибок
  - Добавлена навигация между страницами
  - Настроен макет приложения с меню
- 01.04.2025 - Реализована структура для работы с продажами:
  - Использована существующая модель Sale с полями Id, OrderId, StockId, SaleDate, SaleType
  - Созданы DTO для API (SaleDto, CreateSaleDto, UpdateSaleDto)
  - Расширен интерфейс ISalesStore методом Delete
  - Реализован контроллер SalesController с CRUD операциями
  - Добавлена защита API с помощью JWT аутентификации
  - Настроены связи с заказами и складами
- 01.04.2025 - Созданы DTO для всех моделей:
  - Заказы (OrderDto, CreateOrderDto, UpdateOrderDto)
  - Доставка (DeliveryDto, CreateDeliveryDto, UpdateDeliveryDto)
  - Товары в заказе (OrderProductDto, CreateOrderProductDto, UpdateOrderProductDto)
  - Склады (StockDto, CreateStockDto, UpdateStockDto)
  - Товары на складе (StockProductDto, CreateStockProductDto, UpdateStockProductDto)
  - Товары (ProductDto, CreateProductDto, UpdateProductDto)
- 01.04.2025 - Настроена аутентификация и авторизация:
  - Создан сервис JwtService для работы с JWT токенами
  - Реализованы DTO для аутентификации (LoginDto, RegisterDto, AuthResponseDto, UserDto)
  - Создан контроллер AuthController с методами:
    - POST /api/auth/login - вход в систему
    - POST /api/auth/register - регистрация
    - GET /api/auth/me - получение информации о текущем пользователе
  - Добавлены политики авторизации:
    - RequireAdminRole - только для администраторов
    - RequireManagerRole - для администраторов и менеджеров
    - RequireUserRole - для всех авторизованных пользователей
  - Настроена валидация входных данных
  - Реализована обработка ошибок аутентификации
- 01.04.2025 - Удаление логики оптовых продаж:
  - Удалена логика оптовых продаж из проекта
  - Обновлены модели и DTO для соответствия новой структуре
  - Упрощена модель ценообразования (единое поле цены)

- 01.04.2025 - Создание DTO и контроллеров:
  - Созданы DTO для клиентов и сотрудников
  - Реализованы контроллеры:
    - `ClientsController` с CRUD операциями
    - `EmployeesController` с CRUD операциями
  - Обновлен `ProductsController` для работы с единым полем цены
  - Настроена авторизация и политики доступа

- 01.04.2025 - Исправление проблем с файлами проекта:
  - Обнаружена проблема в Rider с поиском `Server.csproj`
  - Файл проекта переименован из `Application.csproj` в `Server.csproj`
  - Обновлены ссылки в файле решения
  - Удален лишний файл решения `Application.sln`
  - Оставлен только `RSAS.sln` в корневой директории

- 01.04.2025 - Улучшение документации API:
  - Добавлены XML-комментарии ко всем контроллерам
  - Создан фильтр `SwaggerAuthorizeOperationFilter` для отображения требований авторизации
  - Обновлена конфигурация Swagger в `Program.cs`
  - Настроена генерация XML-комментариев в файле проекта
  - Добавлены подробные описания эндпоинтов и параметров
  - Настроено отображение требований авторизации в Swagger UI

## Критерии качества
- Корректная работа всех функций после миграции
- Безопасность данных и аутентификации
- Надежность и отказоустойчивость
- Производительность API
- Удобство поддержки кода

## Дополнительная информация
- Проект является модернизацией существующего решения
- Необходимо обеспечить плавный переход на новую архитектуру
- Важно сохранить все существующие функции при миграции
- Требуется тщательное тестирование на каждом этапе разработки
- Необходимо обеспечить обратную совместимость API 

## План разработки (2 месяца)
### Месяц 1
1. Неделя 1-2:
   - [x] Разделение проекта на Server и Frontend
   - [x] Настройка базовой структуры
   - [x] Реализация базового функционала заказов
   - [ ] Настройка аутентификации и авторизации

2. Неделя 3-4:
   - [ ] Реализация функционала продаж
   - [ ] Реализация функционала товаров
   - [ ] Интеграция всех компонентов
   - [ ] Базовое тестирование

### Месяц 2
1. Неделя 1-2:
   - [ ] Расширенное тестирование
   - [ ] Оптимизация производительности
   - [ ] Улучшение UI/UX
   - [ ] Документация

2. Неделя 3-4:
   - [ ] Финальное тестирование
   - [ ] Исправление багов
   - [ ] Подготовка к развертыванию
   - [ ] Финальная документация

## Текущий прогресс
### Завершено:
1. Базовая структура проекта с JWT аутентификацией и авторизацией
2. Все основные контроллеры (Orders, Products, Sales, Stocks, Employees, Clients)
3. Настроены операции с базой данных через Entity Framework Core
4. Созданы основные сервисы и репозитории
5. Реализована безопасность (ролевой доступ, валидация входных данных)
6. Настроена инфраструктура (Swagger для API, middleware для обработки ошибок)
7. Созданы тесты для контроллеров

### В процессе:
1. Тестирование WEB API (unit-тесты, интеграционные тесты)
2. Разработка frontend части
3. Документация

### Планируется:
1. Оптимизация производительности API
2. Оптимизация запросов к базе данных
3. Улучшение UI/UX
4. Дополнительные функции (отчеты, аналитика продаж)

## Разработка системы аналитики

### Основные разделы аналитики:

#### 1. Общая аналитика (Dashboard)
- Ключевые показатели (KPI) в реальном времени
- Графики динамики продаж
- Топ товаров/категорий
- Анализ эффективности

#### 2. Аналитика продаж
- Динамика продаж (по дням/неделям/месяцам)
- Анализ по категориям товаров
- Сравнительный анализ периодов
- Прогнозы продаж
- Анализ маржинальности

#### 3. Аналитика заказов
- Статистика по заказам
- Время обработки заказов
- Средний чек
- Анализ отмененных заказов

### Типы отчетов для печати:

#### 1. Отчет по продажам
- Общая выручка
- Продажи по категориям
- Динамика продаж
- Маржинальность

#### 2. Отчет по заказам
- Количество заказов
- Средний чек
- Время обработки
- Статистика отмен

#### 3. Отчет по ключевым показателям
- Основные KPI
- Сравнение с предыдущими периодами
- Тренды

### Функциональность:

#### 1. Фильтрация и группировка
- По датам (гибкие периоды)
- По категориям товаров
- По клиентам
- По статусам

#### 2. Визуализация
- Интерактивные графики
- Диаграммы
- Таблицы с сортировкой

#### 3. Экспорт
- Экспорт в Excel/PDF
- Возможность настройки формата отчета

### План реализации:

1. Создание базовой структуры
   - Модели данных для аналитики
   - Сервисы для агрегации данных
   - Базовые контроллеры

2. Реализация основных KPI
   - Выручка
   - Количество продаж
   - Средний чек
   - Маржинальность

3. Разработка базовых отчетов
   - Отчет по продажам
   - Отчет по заказам
   - Отчет по KPI

4. Добавление интерактивных графиков
   - Динамика продаж
   - Распределение по категориям
   - Сравнение периодов

### Технические особенности:

1. Производительность
   - Кэширование данных
   - Асинхронная загрузка
   - Оптимизация запросов
   - Индексация данных

2. Масштабируемость
   - Модульная архитектура
   - Возможность расширения
   - Поддержка больших объемов данных

3. Безопасность
   - Ролевой доступ к данным
   - Аудит действий
   - Защита конфиденциальных данных

4. Интеграция с существующей системой
   - Использование текущих моделей данных
   - Расширение существующих сервисов
   - Миграция данных

## Известные проблемы и задачи
1. Высокий приоритет:
   - [ ] Реализация функционала продаж
   - [ ] Реализация функционала товаров
   - [ ] Расширенное тестирование

2. Средний приоритет:
   - [ ] Оптимизация производительности
   - [ ] Улучшение UI/UX
   - [ ] Документация

3. Низкий приоритет:
   - [ ] Дополнительные функции
   - [ ] Улучшение отчетности
   - [ ] Оптимизация базы данных

## Технический долг
- [ ] Добавить логирование
- [ ] Улучшить обработку ошибок
- [ ] Добавить кэширование
- [ ] Оптимизировать запросы к БД
- [ ] Добавить unit-тесты

## Следующие шаги
1. Реализация функционала продаж:
   - Создание моделей данных
   - Реализация API
   - Создание UI компонентов
   - Интеграция с существующим функционалом

2. Реализация функционала товаров:
   - Создание моделей данных
   - Реализация API
   - Создание UI компонентов
   - Интеграция с заказами и продажами

3. Тестирование:
   - Написание unit-тестов
   - Интеграционное тестирование
   - UI тестирование
   - Нагрузочное тестирование 

## Последние изменения (03.04.2024)
1. Улучшена обработка ошибок:
   - Добавлен `ErrorHandlingMiddleware` для централизованной обработки исключений
   - Реализована обработка различных типов исключений
   - Добавлено логирование ошибок

2. Настроены CORS-политики:
   - Добавлена поддержка разных окружений (Development, Production)
   - Настроена поддержка учетных данных
   - Добавлена поддержка различных методов и заголовков

3. Улучшена работа с базой данных:
   - Созданы и применены миграции
   - Настроена конфигурация подключения к базе данных
   - Добавлен начальный сид данных для ролей и пользователей

4. Настроен Swagger UI:
   - Добавлена поддержка JWT-авторизации
   - Реализован фильтр безопасности для отображения защищенных эндпоинтов
   - Настроено отображение описаний ошибок авторизации

5. Начата работа над тестированием:
   - Создан проект для модульных тестов
   - Подготовлена структура для тестирования API
   - Настроены зависимости для тестирования

## Следующие шаги
1. Реализация модульных тестов для API
2. Разработка клиентской части на Razor Pages
3. Интеграция клиентской и серверной частей
4. Тестирование всей системы
5. Деплой приложения

## Технический стек
### Backend
- ASP.NET Core 7.0
  - Web API
  - Entity Framework Core
  - Identity для аутентификации
  - JWT для авторизации
  - AutoMapper для маппинга DTO
  - Swagger/OpenAPI для документации
  - CORS для работы с фронтендом

### База данных
- SQL Server
  - Entity Framework Core для ORM
  - Миграции для управления схемой
  - Репозитории для доступа к данным

### Frontend (в разработке)
- ASP.NET Core Razor Pages
  - Серверный рендеринг
  - Tag Helpers
  - Встроенная валидация форм
  - Bootstrap для стилизации

### Тестирование
- xUnit для unit-тестов
- Moq для мокирования зависимостей
- Тестовое окружение с отдельной конфигурацией

### Инфраструктура
- Git для контроля версий
- CI/CD (в процессе настройки)
- Docker (планируется)
- Azure (планируется для деплоя)

### Безопасность
- JWT аутентификация
- Ролевая модель:
  - Manager (Менеджер) - полный доступ к системе, управление заказами, товарами, складами, клиентами и сотрудниками
  - User (Пользователь) - ограниченный доступ, возможность просмотра своих заказов и создания новых
- Политики авторизации
- Валидация входных данных
- Обработка исключений
- CORS политики

## Структура проекта
```
Applications/
├── Server/                 # Серверная часть (ASP.NET Core Web API)
│   ├── Controllers/        # Контроллеры API
│   │   ├── AuthController.cs      # Аутентификация и авторизация
│   │   ├── ClientsController.cs   # Управление клиентами
│   │   ├── EmployeesController.cs # Управление сотрудниками
│   │   ├── OrdersController.cs    # Управление заказами
│   │   ├── ProductsController.cs  # Управление товарами
│   │   ├── SalesController.cs     # Управление продажами
│   │   └── StocksController.cs    # Управление складами
│   ├── Models/            # Модели данных
│   ├── Services/          # Сервисы бизнес-логики
│   ├── Data/              # Контекст базы данных и миграции
│   ├── DTOs/              # Data Transfer Objects
│   ├── Exceptions/        # Пользовательские исключения
│   ├── Filters/           # Фильтры для API
│   ├── Middleware/        # Middleware компоненты
│   ├── Extentions/        # Расширения
│   ├── Attributes/        # Пользовательские атрибуты
│   └── Migrations/        # Миграции базы данных
├── Server.Tests/          # Проект для модульных тестов
│   ├── Controllers/       # Тесты контроллеров
│   ├── TestBase.cs        # Базовый класс для тестов
│   └── appsettings.Testing.json # Конфигурация для тестов
└── Frontend/              # Клиентская часть (в разработке)
```

## Учетные данные для тестирования
- Менеджер:
  - Email: Manager@gmail.com
  - Password: Manager123
- Клиент:
  - Email: Client@gmail.com
  - Password: Client123 